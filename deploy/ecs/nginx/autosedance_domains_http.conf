# Template: /etc/nginx/conf.d/autosedance.conf
#
# Domain + HTTP mode (temporary):
# - Use this when you don't have TLS certs yet.
# - Once certs are ready, switch to nginx/autosedance_domains.conf (HTTPS).
#
# Publicly expose ONLY Nginx 80 (and later 443). Keep Uvicorn and Next.js bound to 127.0.0.1.

limit_req_zone $binary_remote_addr zone=api_general:10m rate=120r/m;
limit_req_zone $binary_remote_addr zone=auth_register:10m rate=30r/m;
limit_req_zone $binary_remote_addr zone=auth_login:10m rate=60r/m;

upstream autosedance_next {
  server 127.0.0.1:3612;
  keepalive 64;
}

server {
  listen 80;
  server_name aiden-novak.com www.aiden-novak.com origin.aiden-novak.com;

  client_max_body_size 300m;

  proxy_set_header Host $host;
  proxy_set_header X-Real-IP $remote_addr;
  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  proxy_set_header X-Forwarded-Proto $scheme;

  proxy_connect_timeout 30s;
  proxy_send_timeout 600s;
  proxy_read_timeout 600s;

  # API: FastAPI
  location = /api/health { proxy_pass http://127.0.0.1:8000; }
  location = /api/auth/register {
    limit_req zone=auth_register burst=10 nodelay;
    proxy_pass http://127.0.0.1:8000;
  }
  location = /api/auth/login {
    limit_req zone=auth_login burst=20 nodelay;
    proxy_pass http://127.0.0.1:8000;
  }
  location /api/ {
    limit_req zone=api_general burst=60 nodelay;
    proxy_pass http://127.0.0.1:8000;
  }

  # Staging: FastAPI
  location = /api-staging/health { proxy_pass http://127.0.0.1:8001/api/health; }
  location = /api-staging/auth/register {
    limit_req zone=auth_register burst=10 nodelay;
    proxy_pass http://127.0.0.1:8001/api/auth/register;
  }
  location = /api-staging/auth/login {
    limit_req zone=auth_login burst=20 nodelay;
    proxy_pass http://127.0.0.1:8001/api/auth/login;
  }
  location /api-staging/ {
    limit_req zone=api_general burst=60 nodelay;
    proxy_pass http://127.0.0.1:8001/api/;
  }

  # Frontend: Next.js
  location / {
    proxy_http_version 1.1;
    proxy_set_header Connection "";
    proxy_pass http://autosedance_next;
  }
}


# Template: /etc/nginx/conf.d/autosedance.conf
#
# No-domain mode: HTTP only (listen 80). Once you have a domain, switch to HTTPS (443)
# and update Vercel BACKEND_INTERNAL_URL to https://...
#
# Publicly expose ONLY Nginx 80/443. Keep Uvicorn on 127.0.0.1:8000/8001.

# Basic rate limit zones (tune as needed).
limit_req_zone $binary_remote_addr zone=api_general:10m rate=120r/m;
limit_req_zone $binary_remote_addr zone=auth_request_code:10m rate=6r/m;
limit_req_zone $binary_remote_addr zone=auth_verify_code:10m rate=30r/m;
limit_req_zone $binary_remote_addr zone=auth_register:10m rate=30r/m;
limit_req_zone $binary_remote_addr zone=auth_login:10m rate=60r/m;

server {
  listen 80;
  server_name _;

  # Match MAX_UPLOAD_MB (example: 300m)
  client_max_body_size 300m;

  # Common proxy headers (needed for real client IP + scheme).
  proxy_set_header Host $host;
  proxy_set_header X-Real-IP $remote_addr;
  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  proxy_set_header X-Forwarded-Proto $scheme;

  # Uploads can take time.
  proxy_connect_timeout 30s;
  proxy_send_timeout 600s;
  proxy_read_timeout 600s;

  # --- PROD (/api/*) -> 127.0.0.1:8000 ---

  location = /api/health {
    proxy_pass http://127.0.0.1:8000;
  }

  location = /api/auth/request_code {
    limit_req zone=auth_request_code burst=10 nodelay;
    proxy_pass http://127.0.0.1:8000;
  }

  location = /api/auth/verify_code {
    limit_req zone=auth_verify_code burst=20 nodelay;
    proxy_pass http://127.0.0.1:8000;
  }

  location = /api/auth/register {
    limit_req zone=auth_register burst=10 nodelay;
    proxy_pass http://127.0.0.1:8000;
  }

  location = /api/auth/login {
    limit_req zone=auth_login burst=20 nodelay;
    proxy_pass http://127.0.0.1:8000;
  }

  location /api/ {
    limit_req zone=api_general burst=60 nodelay;
    proxy_pass http://127.0.0.1:8000;
  }

  # --- STAGING (/api-staging/*) -> 127.0.0.1:8001 ---
  #
  # Convert /api-staging/<path> to /api/<path> for the app.

  location = /api-staging/health {
    proxy_pass http://127.0.0.1:8001/api/health;
  }

  location = /api-staging/auth/request_code {
    limit_req zone=auth_request_code burst=10 nodelay;
    proxy_pass http://127.0.0.1:8001/api/auth/request_code;
  }

  location = /api-staging/auth/verify_code {
    limit_req zone=auth_verify_code burst=20 nodelay;
    proxy_pass http://127.0.0.1:8001/api/auth/verify_code;
  }

  location = /api-staging/auth/register {
    limit_req zone=auth_register burst=10 nodelay;
    proxy_pass http://127.0.0.1:8001/api/auth/register;
  }

  location = /api-staging/auth/login {
    limit_req zone=auth_login burst=20 nodelay;
    proxy_pass http://127.0.0.1:8001/api/auth/login;
  }

  location /api-staging/ {
    limit_req zone=api_general burst=60 nodelay;
    proxy_pass http://127.0.0.1:8001/api/;
  }
}


# Template: /etc/nginx/conf.d/autosedance.conf
#
# Domain + HTTPS mode:
# - Mainland China users: aiden-novak.com / www.aiden-novak.com -> this ECS
# - Overseas users: aiden-novak.com / www.aiden-novak.com -> Vercel (via Aliyun DNS smart/geo routing)
# - Vercel server-to-server API rewrites should use: origin.aiden-novak.com (ALWAYS ECS, no geo)
#
# IMPORTANT: Use DNS-01 for TLS certs, because geo DNS can break HTTP-01.
#
# Publicly expose ONLY Nginx 80/443. Keep Uvicorn and Next.js bound to 127.0.0.1.

# Basic rate limit zones (tune as needed).
limit_req_zone $binary_remote_addr zone=api_general:10m rate=120r/m;
limit_req_zone $binary_remote_addr zone=auth_register:10m rate=30r/m;
limit_req_zone $binary_remote_addr zone=auth_login:10m rate=60r/m;

# --- HTTP -> HTTPS redirects ---

server {
  listen 80;
  server_name aiden-novak.com www.aiden-novak.com;
  return 301 https://$host$request_uri;
}

server {
  listen 80;
  server_name origin.aiden-novak.com;
  return 301 https://$host$request_uri;
}

# --- HTTPS: API-only origin for Vercel rewrites ---
#
# Vercel env:
# - Production BACKEND_INTERNAL_URL=https://origin.aiden-novak.com/api
# - Preview    BACKEND_INTERNAL_URL=https://origin.aiden-novak.com/api-staging

server {
  listen 443 ssl http2;
  server_name origin.aiden-novak.com;

  # Replace with your DNS-01 certificate paths.
  ssl_certificate     /etc/letsencrypt/live/origin.aiden-novak.com/fullchain.pem;
  ssl_certificate_key /etc/letsencrypt/live/origin.aiden-novak.com/privkey.pem;

  # Match MAX_UPLOAD_MB (example: 300m)
  client_max_body_size 300m;

  # Common proxy headers (needed for real client IP + scheme).
  proxy_set_header Host $host;
  proxy_set_header X-Real-IP $remote_addr;
  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  proxy_set_header X-Forwarded-Proto $scheme;

  # Uploads can take time.
  proxy_connect_timeout 30s;
  proxy_send_timeout 600s;
  proxy_read_timeout 600s;

  # --- PROD (/api/*) -> 127.0.0.1:8000 ---
  location = /api/health { proxy_pass http://127.0.0.1:8000; }
  location = /api/auth/register {
    limit_req zone=auth_register burst=10 nodelay;
    proxy_pass http://127.0.0.1:8000;
  }
  location = /api/auth/login {
    limit_req zone=auth_login burst=20 nodelay;
    proxy_pass http://127.0.0.1:8000;
  }
  location /api/ {
    limit_req zone=api_general burst=60 nodelay;
    proxy_pass http://127.0.0.1:8000;
  }

  # --- STAGING (/api-staging/*) -> 127.0.0.1:8001 ---
  location = /api-staging/health { proxy_pass http://127.0.0.1:8001/api/health; }
  location = /api-staging/auth/register {
    limit_req zone=auth_register burst=10 nodelay;
    proxy_pass http://127.0.0.1:8001/api/auth/register;
  }
  location = /api-staging/auth/login {
    limit_req zone=auth_login burst=20 nodelay;
    proxy_pass http://127.0.0.1:8001/api/auth/login;
  }
  location /api-staging/ {
    limit_req zone=api_general burst=60 nodelay;
    proxy_pass http://127.0.0.1:8001/api/;
  }

  # Everything else: this origin is API-only.
  location / { return 404; }
}

# --- HTTPS: China frontend + API on ECS ---

upstream autosedance_next {
  # Next.js runs locally via systemd (deploy/ecs/systemd/autosedance-web.service)
  server 127.0.0.1:3612;
  keepalive 64;
}

server {
  listen 443 ssl http2;
  server_name aiden-novak.com www.aiden-novak.com;

  # Replace with your DNS-01 certificate paths.
  ssl_certificate     /etc/letsencrypt/live/aiden-novak.com/fullchain.pem;
  ssl_certificate_key /etc/letsencrypt/live/aiden-novak.com/privkey.pem;

  client_max_body_size 300m;

  proxy_set_header Host $host;
  proxy_set_header X-Real-IP $remote_addr;
  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  proxy_set_header X-Forwarded-Proto $scheme;

  proxy_connect_timeout 30s;
  proxy_send_timeout 600s;
  proxy_read_timeout 600s;

  # API: send to FastAPI (same as deploy/ecs/nginx/autosedance.conf)
  location = /api/health { proxy_pass http://127.0.0.1:8000; }
  location = /api/auth/register {
    limit_req zone=auth_register burst=10 nodelay;
    proxy_pass http://127.0.0.1:8000;
  }
  location = /api/auth/login {
    limit_req zone=auth_login burst=20 nodelay;
    proxy_pass http://127.0.0.1:8000;
  }
  location /api/ {
    limit_req zone=api_general burst=60 nodelay;
    proxy_pass http://127.0.0.1:8000;
  }

  location = /api-staging/health { proxy_pass http://127.0.0.1:8001/api/health; }
  location = /api-staging/auth/register {
    limit_req zone=auth_register burst=10 nodelay;
    proxy_pass http://127.0.0.1:8001/api/auth/register;
  }
  location = /api-staging/auth/login {
    limit_req zone=auth_login burst=20 nodelay;
    proxy_pass http://127.0.0.1:8001/api/auth/login;
  }
  location /api-staging/ {
    limit_req zone=api_general burst=60 nodelay;
    proxy_pass http://127.0.0.1:8001/api/;
  }

  # Frontend: everything else -> Next.js
  location / {
    proxy_http_version 1.1;
    proxy_set_header Connection "";
    proxy_pass http://autosedance_next;
  }
}

